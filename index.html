<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alumni Reunion Survey</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Styling for draggable items */
        .draggable-item {
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            user-select: none; /* Prevent text selection during drag */
        }
        .draggable-item:active {
            cursor: grabbing;
            transform: scale(1.02); /* Slight scale effect when grabbed */
        }
        /* Styling for drop zone when item is dragged over it */
        .drop-zone.drag-over {
            border-color: #60A5FA; /* Blue-400 */
            background-color: #DBEAFE; /* Blue-100 */
        }
        /* Styling for a dragged item (ghost effect) */
        .dragging {
            opacity: 0.5;
            border-style: dashed;
            border-color: #9CA3AF; /* Gray-400 */
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 sm:p-6 md:p-8">

    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl max-w-4xl w-full border border-gray-200">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-6 text-gray-800 leading-tight">
            North America Alumni Reunion Survey
        </h1>

        <p class="text-gray-600 mb-8 text-center text-base sm:text-lg">
            Your input is invaluable for planning our next alumni reunion! Please fill out the survey below.
        </p>

        <form id="reunion-survey-form" class="space-y-6">
            <!-- Section 1: Contact Information & General Interest -->
            <div class="p-5 rounded-lg border border-gray-200 bg-gray-50">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Section 1: Your Details & Interest</h2>

                <div class="mb-4">
                    <label for="fullName" class="block text-gray-700 text-sm font-bold mb-2">Your Full Name:</label>
                    <input type="text" id="fullName" name="fullName" required
                           class="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-indigo-400">
                </div>

                <div class="mb-4">
                    <label for="email" class="block text-gray-700 text-sm font-bold mb-2">Your Email Address:</label>
                    <input type="email" id="email" name="email" required
                           class="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-indigo-400">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Are you interested in attending a North America Alumni Reunion in Summer 2026?</label>
                    <div class="mt-2 space-y-2">
                        <label class="inline-flex items-center">
                            <input type="radio" name="attendanceInterest" value="Yes, definitely!" class="form-radio text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">Yes, definitely!</span>
                        </label>
                        <label class="inline-flex items-center ml-4">
                            <input type="radio" name="attendanceInterest" value="Most likely, if dates/location work." class="form-radio text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">Most likely, if dates/location work.</span>
                        </label>
                        <label class="inline-flex items-center ml-4">
                            <input type="radio" name="attendanceInterest" value="Maybe, I need more details." class="form-radio text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">Maybe, I need more details.</span>
                        </label>
                        <label class="inline-flex items-center ml-4">
                            <input type="radio" name="attendanceInterest" value="Unlikely at this time." class="form-radio text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">Unlikely at this time.</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Section 2: Volunteer Interest (with Drag & Drop) -->
            <div class="p-5 rounded-lg border border-gray-200 bg-gray-50">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Section 2: Volunteer Interest</h2>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Are you interested in volunteering to help organize the reunion?</label>
                    <div class="mt-2 space-y-2">
                        <label class="inline-flex items-center">
                            <input type="radio" name="volunteerInterest" value="Yes, I'd love to help with planning!" class="form-radio text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">Yes, I'd love to help with planning!</span>
                        </label>
                        <label class="inline-flex items-center ml-4">
                            <input type="radio" name="volunteerInterest" value="Maybe, I'd like more information on roles." class="form-radio text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">Maybe, I'd like more information on roles.</span>
                        </label>
                        <label class="inline-flex items-center ml-4">
                            <input type="radio" name="volunteerInterest" value="No, but I'm excited to attend!" class="form-radio text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">No, but I'm excited to attend!</span>
                        </label>
                    </div>
                </div>

                <div id="volunteer-roles-section" class="hidden mt-6">
                    <p class="text-gray-600 mb-4 text-base sm:text-lg">
                        Drag and drop your preferred volunteer roles from the "Available Roles" list to "My Prioritized Roles" to rank them in order of your interest.
                    </p>

                    <div class="flex flex-col md:flex-row gap-6 md:gap-8">
                        <!-- Available Roles Section -->
                        <div class="flex-1 bg-blue-50 p-4 sm:p-5 rounded-lg border-2 border-blue-200 shadow-inner">
                            <h3 class="text-xl font-bold mb-4 text-blue-800">Available Roles</h3>
                            <div id="available-roles" class="min-h-[200px] space-y-3 p-2 bg-blue-100 rounded-md border border-blue-300">
                                <!-- Draggable items -->
                                <div id="role1" draggable="true" class="draggable-item bg-white p-3 rounded-md shadow-sm cursor-grab hover:bg-blue-200 text-gray-700 font-medium">Venue & Logistics</div>
                                <div id="role2" draggable="true" class="draggable-item bg-white p-3 rounded-md shadow-sm cursor-grab hover:bg-blue-200 text-gray-700 font-medium">Activities & Entertainment</div>
                                <div id="role3" draggable="true" class="draggable-item bg-white p-3 rounded-md shadow-sm cursor-grab hover:bg-blue-200 text-gray-700 font-medium">Communications & Marketing</div>
                                <div id="role4" draggable="true" class="draggable-item bg-white p-3 rounded-md shadow-sm cursor-grab hover:bg-blue-200 text-gray-700 font-medium">Sponsorship & Fundraising</div>
                                <div id="role5" draggable="true" class="draggable-item bg-white p-3 rounded-md shadow-sm cursor-grab hover:bg-blue-200 text-gray-700 font-medium">Registration & Check-in</div>
                                <div id="role6" draggable="true" class="draggable-item bg-white p-3 rounded-md shadow-sm cursor-grab hover:bg-blue-200 text-gray-700 font-medium">Alumni Outreach</div>
                            </div>
                        </div>

                        <!-- Drop Zone Section -->
                        <div class="flex-1 bg-green-50 p-4 sm:p-5 rounded-lg border-2 border-green-200 shadow-inner">
                            <h3 class="text-xl font-bold mb-4 text-green-800">My Prioritized Roles</h3>
                            <div id="prioritized-roles" class="drop-zone min-h-[200px] border-2 border-dashed border-green-400 p-3 rounded-md flex flex-col gap-3 bg-green-100">
                                <p id="drop-zone-placeholder" class="text-gray-500 text-sm italic text-center mt-8">Drag roles here to prioritize them</p>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="prioritizedRolesOutput" name="prioritizedRolesOutput">
                </div>
            </div>

            <!-- Section 3: Location & Preferences -->
            <div class="p-5 rounded-lg border border-gray-200 bg-gray-50">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Section 3: Location & Preferences</h2>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">If the reunion were held in California, which region would you most prefer?</label>
                    <div class="mt-2 space-y-2">
                        <label class="inline-flex items-center">
                            <input type="radio" name="californiaRegion" value="Northern California (e.g., San Francisco Bay Area, Sacramento)" class="form-radio text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">Northern California (e.g., San Francisco Bay Area, Sacramento)</span>
                        </label>
                        <label class="inline-flex items-center ml-4">
                            <input type="radio" name="californiaRegion" value="Southern California (e.g., Los Angeles, San Diego, Orange County)" class="form-radio text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">Southern California (e.g., Los Angeles, San Diego, Orange County)</span>
                        </label>
                        <label class="inline-flex items-center ml-4">
                            <input type="radio" name="californiaRegion" value="Central Valley (e.g., Fresno, Bakersfield)" class="form-radio text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">Central Valley (e.g., Fresno, Bakersfield)</span>
                        </label>
                        <label class="inline-flex items-center ml-4">
                            <input type="radio" name="californiaRegion" value="No strong preference within California." class="form-radio text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">No strong preference within California.</span>
                        </label>
                        <label class="inline-flex items-center ml-4">
                            <input type="radio" name="californiaRegion" value="Other" class="form-radio text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">I'd prefer a different state in North America (please specify below).</span>
                        </label>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="otherLocation" class="block text-gray-700 text-sm font-bold mb-2">If "Other" for location, please specify:</label>
                    <input type="text" id="otherLocation" name="otherLocation"
                           class="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-indigo-400">
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">What type of reunion activities are you most interested in? (Select all that apply)</label>
                    <div class="mt-2 space-y-2">
                        <label class="inline-flex items-center">
                            <input type="checkbox" name="activityInterest" value="Formal Dinner/Gala" class="form-checkbox text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">Formal Dinner/Gala</span>
                        </label>
                        <label class="inline-flex items-center ml-4">
                            <input type="checkbox" name="activityInterest" value="Casual Mixer/Reception" class="form-checkbox text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">Casual Mixer/Reception</span>
                        </label>
                        <label class="inline-flex items-center ml-4">
                            <input type="checkbox" name="activityInterest" value="Campus Tour/Visit (if applicable to alumni)" class="form-checkbox text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">Campus Tour/Visit (if applicable to alumni)</span>
                        </label>
                        <label class="inline-flex items-center ml-4">
                            <input type="checkbox" name="activityInterest" value="Family-Friendly Picnic/BBQ" class="form-checkbox text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">Family-Friendly Picnic/BBQ</span>
                        </label>
                        <label class="inline-flex items-center ml-4">
                            <input type="checkbox" name="activityInterest" value="Guest Speakers/Presentations" class="form-checkbox text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">Guest Speakers/Presentations</span>
                        </label>
                        <label class="inline-flex items-center ml-4">
                            <input type="checkbox" name="activityInterest" value="Outdoor Activities (e.g., hiking, beach day)" class="form-checkbox text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">Outdoor Activities (e.g., hiking, beach day)</span>
                        </label>
                        <label class="inline-flex items-center ml-4">
                            <input type="checkbox" name="activityInterest" value="Networking Opportunities" class="form-checkbox text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">Networking Opportunities</span>
                        </label>
                        <label class="inline-flex items-center ml-4">
                            <input type="checkbox" name="activityInterest" value="Theme Party" class="form-checkbox text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">Theme Party</span>
                        </label>
                        <label class="inline-flex items-center ml-4">
                            <input type="checkbox" name="activityInterest" value="Other" class="form-checkbox text-indigo-600 h-4 w-4">
                            <span class="ml-2 text-gray-700">Other (please specify below)</span>
                        </label>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="otherActivity" class="block text-gray-700 text-sm font-bold mb-2">If "Other" for activities, please specify:</label>
                    <input type="text" id="otherActivity" name="otherActivity"
                           class="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-indigo-400">
                </div>
            </div>

            <!-- Section 4: Additional Thoughts -->
            <div class="p-5 rounded-lg border border-gray-200 bg-gray-50">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">Section 4: Additional Thoughts</h2>
                <div class="mb-4">
                    <label for="additionalThoughts" class="block text-gray-700 text-sm font-bold mb-2">Do you have any other ideas, suggestions, or concerns regarding the reunion that you'd like to share?</label>
                    <textarea id="additionalThoughts" name="additionalThoughts" rows="4"
                              class="shadow appearance-none border rounded-md w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline focus:ring-2 focus:ring-indigo-400"></textarea>
                </div>
            </div>

            <button type="submit" id="submit-survey-btn" class="mt-8 w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition duration-300 ease-in-out shadow-lg transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300">
                Submit Survey
            </button>
        </form>

        <!-- Message Box for feedback -->
        <div id="message-box" class="mt-6 p-4 bg-blue-100 text-blue-800 rounded-lg hidden text-center font-medium shadow-md">
            <!-- Messages will appear here -->
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        let db;
        let userId = crypto.randomUUID(); // Generate a random UUID for each user session
        let isAuthReady = true; // Set to true immediately as no async auth is needed

        const messageBox = document.getElementById('message-box');
        const reunionSurveyForm = document.getElementById('reunion-survey-form');
        const volunteerInterestRadios = document.querySelectorAll('input[name="volunteerInterest"]');
        const volunteerRolesSection = document.getElementById('volunteer-roles-section');
        const prioritizedRolesOutputInput = document.getElementById('prioritizedRolesOutput'); // Hidden input for D&D result

        // Initialize Firebase
        if (Object.keys(firebaseConfig).length > 0) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            showMessage(`Firebase initialized. User ID for this session: ${userId}`, 'info');
        } else {
            showMessage("Firebase configuration not found. Data will not be saved.", 'error');
        }

        // --- Drag & Drop Logic (from previous version, integrated) ---
        const availableRoles = document.getElementById('available-roles');
        const prioritizedRoles = document.getElementById('prioritized-roles');
        const dropZonePlaceholder = document.getElementById('drop-zone-placeholder');

        let draggedItem = null;

        document.querySelectorAll('.draggable-item').forEach(item => {
            item.addEventListener('dragstart', handleDragStart);
        });

        function handleDragStart(e) {
            draggedItem = e.target;
            e.dataTransfer.setData('text/plain', e.target.id);
            e.target.classList.add('dragging');
        }

        prioritizedRoles.addEventListener('dragover', handleDragOver);
        prioritizedRoles.addEventListener('dragenter', handleDragEnter);
        prioritizedRoles.addEventListener('dragleave', handleDragLeave);
        prioritizedRoles.addEventListener('drop', handleDrop);

        availableRoles.addEventListener('dragover', handleDragOver);
        availableRoles.addEventListener('dragenter', handleDragEnter);
        availableRoles.addEventListener('dragleave', handleDragLeave);
        availableRoles.addEventListener('drop', handleDrop);

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
            const target = e.target;
            if (target.classList.contains('draggable-item')) {
                target.classList.add('bg-yellow-100', 'border-yellow-300');
            }
        }

        function handleDragEnter(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
            document.querySelectorAll('.draggable-item').forEach(item => {
                item.classList.remove('bg-yellow-100', 'border-yellow-300');
            });
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            document.querySelectorAll('.draggable-item').forEach(item => {
                item.classList.remove('bg-yellow-100', 'border-yellow-300');
            });

            if (draggedItem) {
                if (e.currentTarget.id === 'prioritized-roles') {
                    if (dropZonePlaceholder && prioritizedRoles.contains(dropZonePlaceholder)) {
                        dropZonePlaceholder.remove();
                    }
                    const afterElement = getDragAfterElement(prioritizedRoles, e.clientY);
                    if (afterElement == null) {
                        prioritizedRoles.appendChild(draggedItem);
                    } else {
                        prioritizedRoles.insertBefore(draggedItem, afterElement);
                    }
                } else if (e.currentTarget.id === 'available-roles') {
                    // If dropping back to available roles, append to that list
                    availableRoles.appendChild(draggedItem);
                    // Re-add placeholder if prioritized list becomes empty
                    updateDropZonePlaceholder();
                }
                draggedItem.classList.remove('dragging');
                draggedItem = null;
            }
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.draggable-item:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        const updateDropZonePlaceholder = () => {
            if (prioritizedRoles.querySelectorAll('.draggable-item').length === 0) {
                if (!prioritizedRoles.contains(dropZonePlaceholder)) {
                    prioritizedRoles.appendChild(dropZonePlaceholder);
                }
            } else {
                if (prioritizedRoles.contains(dropZonePlaceholder)) {
                    dropZonePlaceholder.remove();
                }
            }
        };
        const observer = new MutationObserver(updateDropZonePlaceholder);
        observer.observe(prioritizedRoles, { childList: true });


        // --- UI Logic for Volunteer Section Visibility ---
        volunteerInterestRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === "Yes, I'd love to help with planning!" || e.target.value === "Maybe, I'd like more information on roles.") {
                    volunteerRolesSection.classList.remove('hidden');
                } else {
                    volunteerRolesSection.classList.add('hidden');
                }
            });
        });

        // --- Form Submission Logic ---
        reunionSurveyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showMessage('Submitting your survey...', 'info');

            if (!db) { // Check if db is initialized (firebaseConfig was present)
                showMessage('Firebase Firestore not initialized. Cannot save data. Please check Firebase configuration.', 'error');
                return;
            }

            // Collect all form data
            const formData = new FormData(reunionSurveyForm);
            const surveyData = {};
            for (let [key, value] of formData.entries()) {
                // Handle multiple checkboxes for activityInterest
                if (key === 'activityInterest') {
                    if (!surveyData[key]) {
                        surveyData[key] = [];
                    }
                    surveyData[key].push(value);
                } else {
                    surveyData[key] = value;
                }
            }

            // Get prioritized roles from drag & drop
            const prioritizedItems = Array.from(prioritizedRoles.children)
                                            .filter(child => child.classList.contains('draggable-item'))
                                            .map(item => item.textContent.trim());
            surveyData.prioritizedVolunteerRoles = prioritizedItems.join('; ');

            // Ensure volunteer section data is only saved if visible
            const volunteerInterestValue = document.querySelector('input[name="volunteerInterest"]:checked')?.value;
            if (volunteerInterestValue !== "Yes, I'd l
